################################################################################
#
# No NGINX version headers
#
###############################################################################

server_tokens off;

################################################################################
#
# Pagespeed module configuration
#
################################################################################

pagespeed                           on;
pagespeed RewriteLevel              PassThrough;
pagespeed ModifyCachingHeaders      off;
pagespeed EnableFilters             collapse_whitespace,rewrite_javascript;
pagespeed Disallow                  "*.js*";
pagespeed Disallow                  "*.json*";
pagespeed FileCachePath             /var/cache/nginx/pagespeed;
pagespeed FileCacheSizeKb           1024000;
pagespeed FileCacheCleanIntervalMs  300000;
pagespeed FileCacheInodeLimit       500000;

################################################################################
#
# Catch and handle 400 errors and higher
#
################################################################################

proxy_intercept_errors on;


################################################################################
#
# Resolver means we do not die when an ELB changes IP address
# http://gc-taylor.com/blog/2011/11/10/nginx-aws-elb-name-resolution-resolvers
#
################################################################################

resolver <%= @dns_server_ip %> valid=60s;
resolver_timeout 10s;

################################################################################
#
# Redirect incorrect hosts
#
################################################################################

server {
    listen 80;
    server_name _;
    return 403;
}

############################################################################
# Charset
# http://serverfault.com/questions/312177/how-to-enable-correct-charset-http-header-in-nginx
############################################################################

charset utf-8;

############################################################################
# Setting edition header from cookie value, unless the edition header is already present.
#
# This allows us to set the edition header in the Code environment,
# so that it works similarly to Prod, without being fronted by Fastly.
############################################################################

map $http_cookie $edition_from_cookie {
    ~GU_EDITION=(?<edn>UK|US|AU|INTL)    $edn;
    default                              UK;
}
map $http_x_gu_edition $edition {
    ~.                                   $http_x_gu_edition;
    default                              $edition_from_cookie;
}
proxy_set_header X-Gu-Edition $edition;

############################################################################
# Play does not like badly formed cookies so we don't pass any cookies in
# proxy call. This has the added bonus of ensuring we cannot customize based
# on cookies.
# https://play.lighthouseapp.com/projects/82401-play-20/tickets/821-badly-formed-cookies-cause-request-to-die-with-no-logging
############################################################################

proxy_set_header Cookie '';

############################################################################
# Proxy settings
############################################################################

proxy_buffers 8 16k;
proxy_buffer_size 32k;

proxy_set_header    Host $host;
proxy_set_header    X-Real-IP $remote_addr;
proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header    X-GU-OriginalServer $host;

# http://wiki.nginx.org/HttpProxyModule#proxy_connect_timeout
# This directive assigns a timeout for the connection to the upstream server.
proxy_connect_timeout   2s;

# http://wiki.nginx.org/HttpProxyModule#proxy_read_timeout
# This directive sets the read timeout for the response of the proxied server. It determines how long nginx will
# wait to get the response to a request. The timeout is established not for entire response, but only between two
# operations of reading.
proxy_read_timeout      2s;

# http://wiki.nginx.org/HttpProxyModule#proxy_send_timeout
# This directive assigns timeout with the transfer of request to the upstream server. Timeout is established not on
# entire transfer of request, but only between two write operations.
proxy_send_timeout      2s;

################################################################################
#
# Server block for old r1 subdomains. We bounce all the traffic at the subdomain
# to www.theguardian.com/[subdomain]/path, which then proxies to the legacy
# server (AKA. the s3 archive bucket)
#
# Ref:- https://github.com/guardian/frontend/blob/master/docs/archiving.md
#
################################################################################

server {
    listen       80;
    server_name  users.theguardian.com
                 users.guardian.co.uk;

    rewrite ^/ http://id.theguardian.com permanent;
}

server {
    listen       80;
    server_name  blogs.theguardian.com
                 blogs.guardian.co.uk;

    rewrite ^/ http://www.theguardian.com/tone/blog permanent;
}

server {
    listen       80;
    server_name  commentisfree.theguardian.com
                 commentisfree.guardian.co.uk;

    rewrite ^/ http://www.theguardian.com/commentisfree permanent;
}

server {

    listen       80;
    server_name  business.theguardian.com
                 business.guardian.co.uk
                 music.theguardian.com
                 music.guardian.co.uk
                 lifeandhealth.theguardian.com
                 lifeandhealth.guardian.co.uk
                 sport.theguardian.com
                 sport.guardian.co.uk
                 books.theguardian.com
                 books.guardian.co.uk
                 media.theguardian.com
                 media.guardian.co.uk
                 society.theguardian.com
                 society.guardian.co.uk
                 travel.theguardian.com
                 travel.guardian.co.uk
                 money.theguardian.com
                 money.guardian.co.uk
                 education.theguardian.com
                 education.guardian.co.uk
                 arts.theguardian.com
                 arts.guardian.co.uk
                 politics.theguardian.com
                 politics.guardian.co.uk
                 observer.theguardian.com
                 observer.guardian.co.uk
                 football.theguardian.com
                 football.guardian.co.uk
                 film.theguardian.com
                 film.guardian.co.uk
                 technology.theguardian.com
                 technology.guardian.co.uk
                 environment.theguardian.com
                 environment.guardian.co.uk
                 shopping.theguardian.com
                 shopping.guardian.co.uk
                 century.theguardian.com
                 century.guardian.co.uk;

    # subdomain robots -> www.theguardian.com/robots.txt
    rewrite ^/robots.txt http://www.theguardian.com/robots.txt permanent;

    # prefix subdomain on to the path, Eg. foo.guardian.co.uk/bar -> www.theguardian.com/foo/bar
    if ($host ~* "^(.+)\.(theguardian\.com|guardian\.co\.uk)$") {
        set $subdomain $1;
        rewrite ^/ http://www.theguardian.com/$subdomain$request_uri permanent;
     }
}

################################################################################
#
# Server block for Ajax host
#
################################################################################

server {
    listen      80;
    server_name ~^.*\.nextgen\.guardianapps\.co\.uk$
                origin-api.nextgen.guardianapps.co.uk
                services.guardianapps.co.uk
                services.code.dev-guardianapps.co.uk
                embed.theguardian.com;

    ###########################################################################
    # Backends
    ###########################################################################
    set $applications <%= @applications_loadbalancer %>;
    set $article <%= @article_loadbalancer %>;
    set $facia <%= @facia_loadbalancer %>;
    set $discussion  <%= @discussion_loadbalancer %>;
    set $sport  <%= @sport_loadbalancer %>;
    set $commercial <%= @commercial_loadbalancer %>;
    set $onward  <%= @onward_loadbalancer %>;
    set $rss <%= @rss_loadbalancer %>;

    ############################################################################
    # Error pages and other static files
    ############################################################################

    error_page 500 503 504 /50x.html;
    location = /50x.html {
        root /var/www/;
    }

    error_page 502 /502.html;
    location = /502.html {
        root /var/www/;
    }

    error_page 503 /503.html;
    location = /503.html {
        root /var/www/;
    }

    error_page 400 404 /404.html;
    location = /404.html {
        root /var/www/;
    }

    location = /favicon.ico {
        root /var/www/;
        expires 1d;
    }

    location = /apple-touch-icon.png {
        root /var/www/;
        expires 1d;
    }

    location = /robots.txt {
        alias /var/www/api-robots.txt;
        expires 5m;
    }

    location = /.well-known/globalsign/cert-request/verify.html {
        alias /var/www/verify.html;
        expires 5m;
    }

    location ~ ^.*/mraid.js {
        return 404;
    }

    # very common pattern with adverts
    location ~ ^.*/undefined$ {
        return 404;
    }

    location ~ ^/_(healthcheck|agentcontents)$ {
        return 403;
    }

    ############################################################################
    # Router match rules. NOTE: Order matters.
    # the $request_uri bit makes the resolver work, see:
    # http://gc-taylor.com/blog/2011/11/10/nginx-aws-elb-name-resolution-resolvers
    ############################################################################

    #Weather
    location ~ ^/weather/city(.*)?\.json$               { proxy_pass http://$onward$request_uri; }
    location ~ ^/weather/locations.*                    { proxy_pass http://$onward$request_uri; }
    location ~ ^/weather/forecast(.*)?\.json$           { proxy_pass http://$onward$request_uri; }

    location ~ ^/weatherapi/city(.*)?\.json$            { proxy_pass http://$onward$request_uri; }
    location ~ ^/weatherapi/locations.*                 { proxy_pass http://$onward$request_uri; }
    location ~ ^/weatherapi/forecast(.*)?\.json$        { proxy_pass http://$onward$request_uri; }

    # Discussion
    location ~ ^/discussion/.*\.json$                   { proxy_pass http://$discussion$request_uri; }

    # Open
    location ~ ^/open/.*\.json$                         { proxy_pass http://$discussion$request_uri; }

    # Commercial
    location ~ ^/commercial/.*\.json$                   { proxy_pass http://$commercial$request_uri; }

    # Exception to make sure show more works for most read front
    location ~ ^/most-read/show-more/[^/]+\.json$             { proxy_pass http://$facia$request_uri; }

    # Crosswords
    location ~ ^/crosswords/(cryptic|quick|quiptic|prize|everyman|azed|special|genius|speedy)/[\w\d-]*.svg { proxy_pass http://$applications$request_uri; }

    # Onward
    location ~ ^/most-read.*\.json$                                 { proxy_pass http://$onward$request_uri; }
    location ~ ^/most-read-geo.*\.json$                             { proxy_pass http://$onward$request_uri; }
    location ~ ^/most-read-day.*\.json$                             { proxy_pass http://$onward$request_uri; }
    location ~ ^/ab-most-read.*\.json$                              { proxy_pass http://$onward$request_uri; }
    location ~ ^/popular-in-tag/.*\.json$                           { proxy_pass http://$onward$request_uri; }
    location ~ ^/top-stories.*\.json$                               { proxy_pass http://$onward$request_uri; }
    location ~ ^/related/.*\.json$                                  { proxy_pass http://$onward$request_uri; }
    location ~ ^/preference/.*\.json$                               { proxy_pass http://$onward$request_uri; }
    location ~ ^/cards/opengraph/.*\.json$                          { proxy_pass http://$onward$request_uri; }
    location ~ ^/tagged\.json$                                      { proxy_pass http://$onward$request_uri; }
    location ~ ^/series/.*\.json$                                   { proxy_pass http://$onward$request_uri; }
    location ~ ^/most-referred\.json$                               { proxy_pass http://$onward$request_uri; }
    location ~ ^/(video|audio)/section/.*\.json$                    { proxy_pass http://$onward$request_uri; }
    location ~ ^/(video|audio|gallery|podcast)/most-viewed.json$    { proxy_pass http://$onward$request_uri; }
    location ~ ^/video/end-slate/.*\.json$                          { proxy_pass http://$onward$request_uri; }
    location ~ ^/embed/card/.*$                                     { proxy_pass http://$onward$request_uri; }
    location ~ ^/business-data/stocks\.json                         { proxy_pass http://$onward$request_uri; }

    # Football
    location ~ ^/football/fixtures.*\.json$                                { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/fixtures.*\.json$                       { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/results.*\.json$                                 { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/results.*\.json$                        { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/live(\.[\w]+)?\.json$                            { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/live.*\.json$                           { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/tables(\.[\w]+)?\.json$                          { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/table(\.[\w]+)?\.json$                  { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/[\w\d-]*/table\.json$                   { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/competitions.*\.json$                            { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/teams.*\.json$                                   { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/match/.*\.json$                                  { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/match-day/.*\.json$                              { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/api/.*\.json$                                    { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/fixtures-and-results-container          { proxy_pass http://$sport$request_uri; }

    # Cricket
    location ~ ^/sport/cricket/match/.*\.json$                             { proxy_pass http://$sport$request_uri; }

    # Rugby
    location ~ ^/sport/rugby/api/.*\.json$                                       { proxy_pass http://$sport$request_uri; }

    # Content type patterns
    location ~ ^/embed/video/.*$                                           { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]*/gallery/.*\.json$                                { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*/gallery/.*\.json$                       { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]+(/[\w\d-]*)?/(cartoon|picture|graphic)/.*\.json$  { proxy_pass http://$applications$request_uri; }
    location ~ ^/([\w\d-]+/)+(video|audio)/.*\.json$                       { proxy_pass http://$applications$request_uri; }

    # Facia
    # Tag combiners
    location ~ ^/[\w\d-]+(/[\w\d-]*)?(/[\w\d-]*)?\+[\w\d-]+(/[\w\d-]*)?(/[\w\d-]*)?\.json { proxy_pass http://$facia$request_uri; }

    location ~ "^/[/\w\d-]*/show-more/[/\w\d-]*\.json$"                    { proxy_pass http://$facia$request_uri; }
    location ~ "^(/[\w\d-]+){1,3}/lite\.json$"                             { proxy_pass http://$facia$request_uri; }
    location ~ ^/[/\w\d-]*/front-index.json$                               { proxy_pass http://$facia$request_uri; }
    location ~ ^/[/\w\d-]*/collections/[/\w\d-]*/[\w\d-]*.json$            { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*(\.[\w]+)?\.json$                                 { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*(\.[\w]+)?\.json$                        { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*/[\w\d-]*(\.[\w]+)?\.json$               { proxy_pass http://$facia$request_uri; }

    location ~ ^/collection/.*\.json$                                      { proxy_pass http://$facia$request_uri; }
    location ~ ^/container/.*\.json$                                       { proxy_pass http://$facia$request_uri; }

    # Articles
    # this is not (and yet is) a catch all. It might be useful to read how Nginx processes these locations
    # http://nginx.org/en/docs/http/request_processing.html
    location ~ ^/[\w\d-]*/.*\.json$                                        { proxy_pass http://$article$request_uri; }
}

################################################################################
#
# Server block for Guardian hosts
#
################################################################################

server {
    listen      80;
    server_name www.theguardian.com
                ~^.*\.dev-theguardian\.com$
                origin-www.theguardian.com.guardianapps.co.uk
                localhost          # healthchecks
                <%= @ipaddress %>; # healthchecks

    ###########################################################################
    # Backends
    ###########################################################################
    set $applications <%= @applications_loadbalancer %>;
    set $article <%= @article_loadbalancer %>;
    set $facia <%= @facia_loadbalancer %>;
    set $discussion  <%= @discussion_loadbalancer %>;
    set $sport  <%= @sport_loadbalancer %>;
    set $commercial <%= @commercial_loadbalancer %>;
    set $onward  <%= @onward_loadbalancer %>;
    set $archive  <%= @archive_loadbalancer %>;
    set $s3 s3-eu-west-1.amazonaws.com;
    set $rss <%= @rss_loadbalancer %>;

    set $archive_base /404/www.theguardian.com;

    ############################################################################
    # Error pages and other static files
    ############################################################################

    error_page 500 503 504 /50x.html;
    location = /50x.html {
        root /var/www/;
    }

    error_page 502 /502.html;
    location = /502.html {
        root /var/www/;
    }

    error_page 503 /503.html;
    location = /503.html {
        root /var/www/;
    }

    error_page 404 = @notfound;
    location @notfound {
        proxy_intercept_errors off;
        proxy_pass http://$archive$archive_base$request_uri;
    }

    error_page 400 /404.html;
    location = /404.html {
        root /var/www/;
    }

    location = /favicon.ico {
        root /var/www/;
        expires 1d;
    }

    location = /apple-touch-icon.png {
        root /var/www/;
        expires 1d;
    }

    location = /ico-256.png {
        root /var/www/;
        expires 1d;
    }

    location = /ico-128.png {
        root /var/www/;
        expires 1d;
    }

    location = /ico-60.png {
        root /var/www/;
        expires 1d;
    }

    # https://developer.apple.com/library/prerelease/ios/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html
    location = /apple-app-site-association {
        default_type application/pkcs7-mime;
        alias /var/www/apple-app-site-association.json;
        expires 1h;
    }

    # https://developer.mozilla.org/en-US/Apps/Build/Manifest
    location = /manifest.webapp {
        default_type application/x-web-app-manifest+json;
        alias /var/www/manifest.webapp;
        expires 1h;
    }

    # the ACTUAL robots.txt lives on the CDN
    # this one is in case a bot finds it's way to the load balancer
    location = /robots.txt {
        root /var/www/;
        expires 5m;
    }

    location ~ ^.*/mraid.js {
        return 404;
    }

    # very common pattern with adverts
    location ~ ^.*/undefined$ {
        return 404;
    }

    location ~ ^/_(healthcheck|agentcontents)$ {
        return 403;
    }

    ############################################################################
    # Rewrites
    ############################################################################

    include redirects/redirects.conf;

    ############################################################################
    # Explicit content types for use by X-Accel
    # These should all be internal so they are not directly accessible
    # http://wiki.nginx.org/X-accel
    ############################################################################

    location ~ ^/type/article/(.*)$ {
        internal;
        proxy_pass http://$article/$1;
    }

    location ~ ^/applications/(.*)$ {
        internal;
        proxy_pass http://$applications/$1$is_args$args;
    }

    location ~ ^/facia/(.*)$ {
        internal;
        proxy_pass http://$facia/$1;
    }

    location ~ ^/rss_server/(.*)$ {
        internal;
        proxy_pass http://$rss/$1;
    }

    location ~ ^/s3-archive/(.*)$ {
        internal;

        # S3 will only accept its own Host header
        proxy_set_header Host $s3;

        proxy_pass http://$s3/aws-frontend-archive/$1;
    }

    ############################################################################
    # Discussion API proxy
    ############################################################################
    location ~ ^/guardianapis/discussion(.*)$ {
        # This needs to be HTTPS, since we do not want to send secure cookies
        # unencrypted over the internet.

<% if @gu_stage == 'PROD' %>
        proxy_pass https://discussion.guardianapis.com$1$is_args$args;
<% else %>
        # ideally we would use the discussion.code but the cert is bad
        # in future we can change over
        proxy_pass https://discussion-secure.code.dev-guardianapis.com$1$is_args$args;
<% end %>

        # These proxy_set_header options undo the global rule for
        # clearing the Cookie header. This configuration block needs
        # to have at least one proxy_set_header option, or the Cookie
        # header will not be forwarded correctly.
        proxy_set_header Host      discussion.guardianapis.com;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie "$http_cookie";
    }

    ############################################################################
    # Router match rules. NOTE: Order matters.
    # the $request_uri bit makes the resolver work, see:
    # http://gc-taylor.com/blog/2011/11/10/nginx-aws-elb-name-resolution-resolvers
    ############################################################################

    # external article healthcheck
    location ~ ^/_cdn_healthcheck$                                 { proxy_pass http://$article$request_uri; }

    # Foresee survey
    location ~ ^/surveys/.*$                                    { proxy_pass http://$applications$request_uri; }

    # Google Site Verification
    location ~ ^/google[\w]*\.html$                          { proxy_pass http://$applications$request_uri; }

    # Vanity URLs
    location ~ ^/community-standards$                           { proxy_pass http://$article$request_uri; }
    location ~ ^/community-faqs$                                { proxy_pass http://$article$request_uri; }
    location ~ ^/help/contact-us$                               { proxy_pass http://$article$request_uri; }
    location ~ ^/help/terms-of-service$                         { proxy_pass http://$article$request_uri; }
    location ~ ^/help/privacy-policy$                           { proxy_pass http://$article$request_uri; }
    location ~ ^/help/using-search$                             { proxy_pass http://$article$request_uri; }
    location ~ ^/info/cookies$                                  { proxy_pass http://$article$request_uri; }
    location ~ ^/mobile/insideguardian/ux-android-update$       { proxy_pass http://$article$request_uri; }
    location ~ ^/mobile/guardian-android-app-football$          { proxy_pass http://$article$request_uri; }
    location ~ ^/mobile/help-blackberry-10-app$                 { proxy_pass http://$article$request_uri; }
    location ~ ^/mobile/insideguardian/guardian-blackberry-app$ { proxy_pass http://$article$request_uri; }

    # Discussion
    location ~ ^/discussion/.*$                 { proxy_pass http://$discussion$request_uri; }

    # Commercial
    location ~ ^/commercial/.*$                 { proxy_pass http://$commercial$request_uri; }

    # Crosswords
    location ~ ^/crosswords/(accessible/)?(cryptic|quick|quiptic|prize|everyman|azed|special|genius|speedy)/[0-9]+$ { proxy_pass http://$applications$request_uri; }
    location ~ ^/crosswords/(lookup|search(/results)?)$                                                              { proxy_pass http://$applications$request_uri; }

    # Onward
    location ~ ^/most-read/.*$                   { proxy_pass http://$onward$request_uri; }
    location ~ ^/top-stories.*$                 { proxy_pass http://$onward$request_uri; }
    location ~ ^/related/.*$                    { proxy_pass http://$onward$request_uri; }
    location ~ ^/preference/.*$                 { proxy_pass http://$onward$request_uri; }
    location ~ ^/cards/opengraph/.*$            { proxy_pass http://$onward$request_uri; }
    location ~ ^/gallery/most-viewed.*$         { proxy_pass http://$onward$request_uri; }
    location ~ ^/info/tech-feedback.*$          { proxy_pass http://$onward$request_uri; }

    # Archive

    location ~ ^/404/.*$                        { proxy_pass http://$archive$request_uri; } # temporary test path
    location ~ ^/(business/markets|moneysaving|media/monkeygoesto|media/mediaguardian-100-(.+)(panellists|judges|power-by-sector|power-sector))     { proxy_pass http://$archive$archive_base$request_uri; }
    location ~ ^/.*\.htm(l)?$                   { proxy_pass http://$archive$archive_base$request_uri; }
    location ~ ^/(.*)/(page)/(.*)               { proxy_pass http://$archive$archive_base$request_uri; }

    # Football
    location ~ ^/football/fixtures.*$                                   { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/fixtures.*$                          { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/results.*$                                    { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/results.*$                           { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/live(\.[\w]+)?$                               { proxy_pass http://$sport$request_uri; }
    #slightly conflicting patterns with 'live'
    location ~ ^/football/blog/live/.*$                                 { proxy_pass http://$article$request_uri; }
    location ~ ^/football/[\w\d-]*/live.*$                              { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/tables(\.[\w]+)?$                             { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/table(\.[\w]+)?$                     { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/[\w\d-]*/table(\.[\w]+)?$            { proxy_pass http://$sport$request_uri; }
    # These have now been overridden with Facia fronts
    location ~ ^/football/competitions$                                 { proxy_pass http://$facia$request_uri; }
    location ~ ^/football/teams$                                        { proxy_pass http://$facia$request_uri; }
    location ~ ^/football/competitions.*$                               { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/teams.*$                                      { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/match/.*$                                     { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/match-day/.*$                                 { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/match-redirect/.*$                            { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/[\w\d-]*/overview.*$                          { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/api/.*$                                       { proxy_pass http://$sport$request_uri; }
    location ~ ^/football/world-cup-2014/r2-front-world-cup-embed.*$    { proxy_pass http://$sport$request_uri; }

    # Cricket
    location ~ ^/sport/cricket/match/.*$                             { proxy_pass http://$sport$request_uri; }

    # Rugby
    location ~ ^/sport/rugby/api/.*$                                 { proxy_pass http://$sport$request_uri; }

    # Content type patterns

    location ~ ^/.+/(latest|all|altdate)$                              { proxy_pass http://$applications$request_uri; }

    # dated tag pages
    location ~ ^/.+/\d\d\d\d/\w\w\w/\d\d$                            { proxy_pass http://$applications$request_uri; }

    #short urls with optional campaign code
    location ~ ^/p/.*$                                               { proxy_pass http://$applications$request_uri; }

    location ~ ^/[\w\d-]*/gallery/.*$                                { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*/gallery/.*$                       { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]+(/[\w\d-]*)?/(cartoon|picture|graphic)/.*$  { proxy_pass http://$applications$request_uri; }
    location ~ ^/([\w\d-]+/)+(video|audio)/.*$                       { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]*/interactive/2013/.*$                       { proxy_pass http://$applications$request_uri; }
    location ~ ^/.*/ng-interactive/.*$                               { proxy_pass http://$applications$request_uri; }
    location ~ ^/[\w\d-]*/australia-election-2013-interactive.*$     { proxy_pass http://$applications$request_uri; }

    location ~ ^/sections$                                           { proxy_pass http://$applications$request_uri; }

    # Web App manifest, eg. 2015-06-24-manifest.json
    location ~ ^/\d\d\d\d-\d\d-\d\d-manifest.json.*$                 { proxy_pass http://$applications$request_uri; }
    # ServiceWorker must be served from root for global scoping
    location ~ ^/service-worker\.js$                                 { proxy_pass http://$applications$request_uri; }
    location ~ ^/offline-page\.json$                                 { proxy_pass http://$applications$request_uri; }

    # Tag combiners
    location ~ ^/[\w\d-]+(/[\w\d-]*)?(/[\w\d-]*)?\+[\w\d-]+(/[\w\d-]*)?(/[\w\d-]*)? { proxy_pass http://$facia$request_uri; }

    # Facia
    location ~ ^/humans\.txt$                                   { proxy_pass http://$facia$request_uri; }
    location = /rockabox/rockabox_buster.html                   { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*(/rss)?$                               { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*(/rss)?$                      { proxy_pass http://$facia$request_uri; }
    location ~ ^/[\w\d-]*/[\w\d-]*/[\w\d-]*(/rss)?$             { proxy_pass http://$facia$request_uri; }

    location ~ ^/collection/.*\/rss$                            { proxy_pass http://$facia$request_uri; }

    # Articles
    # this is not (and yet is) a catch all. It might be usefull to read how Nginx processes these locations
    # http://nginx.org/en/docs/http/request_processing.html
    location ~ ^/[\w\d-]*/.*$ { proxy_pass http://$article$request_uri; }
}

# TODO - proxy this to S3 bucket
server {
    listen      80;
    server_name preview.guardianapps.co.uk
                code.preview.guardianapps.co.uk;

    set $facia <%= @facia_loadbalancer %>;

    # Facia responsive viewer util
    location ~ ^/responsive-viewer$                              { proxy_pass http://$facia$request_uri; }
}
